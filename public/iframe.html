<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
    <script>
        function args(str, function_name) {
        // THIS FUNCTION EXTRACTS THE ARGUMENTS OUT OF A FUNCTION STRING

        let i1 = str.indexOf('(') + 1
        let i2 = str.indexOf(')')


        let firstWord = str.split(' ')[0]
        let fourthWord = str.split(' ')[3]

        let assignment = str.indexOf('=') + 1
        let returning = str.indexOf('=>')

        function array(string, i, j) {
            return string.slice(i, j).split(',').map(p => p.trim())
        }

        switch (firstWord) {
            case 'var':
            case 'const':
            case 'let':
                if (fourthWord !== 'function') {
                    let argsArea = str.slice(assignment, returning).trim()
                    let last = argsArea.length - 1
                    if (argsArea == '_') {
                        return [""]
                    }
                    else if (argsArea[0] == '(' && argsArea[last] == ')') {
                        return array(argsArea, 1, last)
                    }
                    else {
                        return array(str, assignment, returning)
                    }
                }
                break;
            default:
                return array(str, i1, i2)
        }
        return array(str, i1, i2)
    }
    function body(str) {
        // THIS FUNCTION RETURNS THE BODY OUT OF A FUNCTION STRING

        let i1 = str.indexOf('{') + 1
        let i2 = str.lastIndexOf('}')
        if (i1 === 0 || i2 === -1) {
            i1 = str.indexOf('=>') + 3
            i2 = str.length
            return 'return ' + str.slice(i1, i2)
        }
        return str.slice(i1, i2)
    }
    function runTests(args, body, tests) {
        let f = new Function(args, body)
        return tests.map(test => {
            test.result = f.apply(null, test.paramaters)
            test.passed = test.result === test.expected_result
            return test
        })
    }

        window.addEventListener('message', function(e) {
                let code = e.data.code;
                let tests = e.data.fight.tests;
                let result =  runTests(args(code), body(code), tests)
               
                var mainWindow = e.source;
                mainWindow.postMessage(result, e.origin);
            });
    </script>
</body>
</html>